<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Keynote Grammar — Sentence Builder (Universal)</title>
<style>


/* =====================================================
   THEME VARIABLES
   ===================================================== */
html[data-theme="dark"] {
  --text:#ffffff;
  --muted:#9aa7c7;
  --bg-panel:#0b1b33;
  --tile:#1e2a47;
  --tile-hover:#2b3f64;
}

html[data-theme="light"] {
  --text:#000000;
  --muted:#4c4c4c;
  --bg-panel:#ffffff;
  --tile:#e6ebf5;
  --tile-hover:#ffffff;
}

/* =====================================================
   BACKGROUND AURORA + MOVING BLOBS (GLOBAL)
   ===================================================== */
body {
  position: relative;
  overflow-x: hidden;
}

/* Base layer */
body::before,
body::after {
  content:"";
  position: fixed;
  top:0; left:0;
  width:100%;
  height:100%;
  z-index:-2;
  pointer-events:none;
  filter: blur(50px);
  opacity:0.65;
  animation: floatBlobs 16s ease-in-out infinite alternate;
}

/* Second blob layer (slower) */
body::after {
  animation-duration: 28s;
  opacity:0.45;
}


/* =====================================================
   DARK MODE BACKGROUND — AURA + DEEP BLOBS
   ===================================================== */
html[data-theme="dark"] body {
  background: radial-gradient(circle at 20% 20%, #0f1629, #0b1430 40%, #040b1a 80%);
}

html[data-theme="dark"] body::before {
  background:
    radial-gradient(circle at 25% 40%, rgba(0,90,255,0.35), transparent 60%),
    radial-gradient(circle at 70% 70%, rgba(0,200,255,0.28), transparent 60%),
    radial-gradient(circle at 50% 20%, rgba(90,0,255,0.35), transparent 70%);
}

html[data-theme="dark"] body::after {
  background:
    radial-gradient(circle at 80% 30%, rgba(0,160,255,0.22), transparent 60%),
    radial-gradient(circle at 20% 80%, rgba(0,80,180,0.18), transparent 70%);
}


/* =====================================================
   LIGHT MODE — MICROSOFT AURORA + SOFT BLOBS
   ===================================================== */
html[data-theme="light"] body {
  background: radial-gradient(circle at 50% 50%, #eef4ff, #ffffff 40%, #eaf0ff 70%);
}

html[data-theme="light"] body::before {
  background:
    radial-gradient(circle at 30% 30%, rgba(180,220,255,0.65), transparent 60%),
    radial-gradient(circle at 75% 70%, rgba(255,200,240,0.55), transparent 70%),
    radial-gradient(circle at 50% 20%, rgba(190,255,240,0.55), transparent 70%);
}

html[data-theme="light"] body::after {
  background:
    radial-gradient(circle at 70% 20%, rgba(150,200,255,0.45), transparent 60%),
    radial-gradient(circle at 20% 70%, rgba(255,220,240,0.45), transparent 60%);
}


/* =====================================================
   BLOB FLOATING ANIMATION
   ===================================================== */
@keyframes floatBlobs {
  0% {
    transform: translate(-40px,-40px) scale(1);
  }
  50% {
    transform: translate(40px,60px) scale(1.15);
  }
  100% {
    transform: translate(-20px,30px) scale(1.05);
  }
}

/* Parallax layers for blobs */
body::before,
body::after {
  will-change: transform;
}


:root{
  --bg:#0f1629; --panel:#0b1b33; --tile:#1e2a47; --tile-hover:#2b3f64;
  --accent:#ffb800; --accent-2:#00eaff; --text:#ffffff; --muted:#9aa7c7;
  --answer-bg:#ffeb3b; --answer-color:#000;
  --success:#b6ffda; --danger:#ffb3b3;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased;
}
.app{max-width:980px;margin:18px auto;padding:18px}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
.title{font-weight:700;font-size:20px}
.controls{display:flex;gap:8px;align-items:center}
button{font-size:14px;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
.small{font-size:13px;padding:6px 10px;color:var(--muted)}

/* progress & xp */
#overall-bar{width:100%;height:12px;background:rgba(255,255,255,0.06);border-radius:10px;overflow:hidden;margin:8px 0 18px}
#overall-fill{width:0%;height:100%;background:linear-gradient(90deg,var(--accent-2),var(--accent));transition:width .5s ease}

/* panel */
.panel{background:var(--panel);border-radius:14px;padding:16px;box-shadow:0 8px 30px rgba(2,6,23,0.45)}

/* play area */
.top-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:space-between}
.progress-text{color:var(--muted);font-size:14px}
.xp-wrap{flex:1;min-width:160px;margin-left:12px}
#xp-bar{width:100%;height:12px;background:rgba(255,255,255,0.04);border-radius:8px;overflow:hidden}
#xp-fill{width:0%;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:width .4s}

/* stars */
.stars{display:flex;gap:6px;align-items:center}
.star{font-size:22px;color:rgba(255,255,255,0.18);transition:color .25s}
.star.active{color:var(--accent)}

/* bank and answer */
.bank-answer{display:flex;gap:12px;margin-top:14px;flex-wrap:wrap}
.word-bank,.answer-zone{flex:1 1 320px;min-height:140px;border-radius:10px;padding:12px;border:2px dashed rgba(255,255,255,0.04);background:linear-gradient(180deg,rgba(255,255,255,0.015),transparent);position:relative;overflow:auto}
.zone-title{font-size:13px;color:var(--muted);margin-bottom:8px;display:flex;align-items:center;gap:8px}

/* punctuation hint badge */
.punct-badge{font-weight:700;color:var(--accent);background:rgba(255,255,255,0.03);padding:4px 8px;border-radius:8px;font-size:13px}

.word-tile {
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:10px 14px;
  margin:8px 8px 0 0;
  border-radius:12px;
  cursor:pointer;
  background:var(--tile);
  color:var(--text);
  font-weight:700;
  user-select:none;
  transition:transform .25s ease, background .15s, box-shadow .25s;
  box-shadow:0 6px 18px rgba(2,6,23,0.28);
  position:relative;
  animation:floatTile 6s ease-in-out infinite;
}

@keyframes floatTile{
  0%{transform:translateY(0px)}
  50%{transform:translateY(-6px)}
  100%{transform:translateY(0px)}
}

.word-tile:hover{
  transform:translateY(-10px) scale(1.05);
  background:var(--tile-hover);
  box-shadow:0 14px 30px rgba(0,0,0,0.35);
}

@keyframes flyToAnswer {
  0% { transform: scale(1) rotate(0deg); opacity:1 }
  40% { transform: scale(1.3) rotate(10deg); opacity:.9 }
  100% { transform: scale(1) rotate(0deg); opacity:1 }
}

.word-tile.fly {
  animation:flyToAnswer 0.45s cubic-bezier(.32,.79,.33,.99);
}


/* actions */
.actions{display:flex;gap:10px;margin-top:14px;align-items:center;flex-wrap:wrap}
.btn-primary{background:var(--accent);color:#000;padding:10px 14px;border-radius:10px;font-weight:700}
.btn-ghost{background:rgba(255,255,255,0.03);color:var(--text);padding:8px 12px;border-radius:10px}

/* message */
#message{margin-top:12px;text-align:center;font-size:16px;min-height:22px}

/* confetti canvas */
#confetti-canvas{position:fixed;pointer-events:none;top:0;left:0;width:100%;height:100%;z-index:9999}
/* fireworks */
#fireworks-overlay{position:fixed;pointer-events:none;top:0;left:0;width:100%;height:100%;z-index:10000;display:none}

/* wrong shake */
@keyframes shake{10%,90%{transform:translateX(-1px)}20%,80%{transform:translateX(2px)}30%,50%,70%{transform:translateX(-4px)}40%,60%{transform:translateX(4px)}}
.shake{animation:shake .6s cubic-bezier(.36,.07,.19,.97)}

/* level select */
.level-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin-top:12px}
.level-card{background:rgba(255,255,255,0.02);padding:14px;border-radius:10px;text-align:center;cursor:pointer}
.level-card.locked{opacity:0.45;cursor:not-allowed}

/* responsive */
@media (max-width:720px){.bank-answer{flex-direction:column}.word-bank,.answer-zone{width:100%}.top-row{flex-direction:column;align-items:flex-start}.xp-wrap{margin-left:0;width:100%}}

/* THEME CONTAINERS */
html[data-theme="dark"] {
  --bg:#0f1629;
  --panel:#0b1b33;
  --tile:#1e2a47;
  --tile-hover:#2b3f64;
  --text:#ffffff;
  --muted:#9aa7c7;
  --answer-bg:#ffeb3b;
  --answer-color:#000;
}



/* LIGHT MODE */
html[data-theme="light"] {
  --bg:#f3f6fb;
  --panel:#ffffff;
  --tile:#e6ebf5;
  --tile-hover:#ffffff;
  --text:#000000;
  --muted:#4c4c4c;
  --answer-bg:#ffeb3b;
  --answer-color:#000;
}


/* SUPER RESPONSIVE MODE */
@media (max-width:480px){
  .title{font-size:17px}
  button{font-size:13px;padding:6px 10px}
  .panel{padding:12px}
  .word-tile{padding:9px 10px;font-size:14px}
  .top-row{flex-direction:column;align-items:flex-start;gap:8px}
}
/* Small toast popup for positive feedback */
.kg-toast {
  position: fixed;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  top: 10vh;
  background: rgba(0,0,0,0.78);
  color: #fff;
  padding: 10px 16px;
  border-radius: 12px;
  font-weight:700;
  z-index: 20000;
  pointer-events: none;
  opacity: 0;
  transition: opacity .22s ease, transform .32s cubic-bezier(.2,.9,.3,1);
  box-shadow: 0 8px 30px rgba(2,6,23,0.45);
  backdrop-filter: blur(6px);
}
.kg-toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}
.kg-toast.good { background: linear-gradient(90deg,#2ec99b,#16a085); color:#071019; }
.kg-toast.warn { background: linear-gradient(90deg,#ffb3b3,#ff6b6b); color:#300; }




/* Ensure no overflow on tiny devices */
body,html{overflow-x:hidden}


</style>
</head>


<body>
<div class="app" id="appRoot">
  <div class="header">
    <div>
      <div class="title" id="pageTitle">Keynote Grammar</div>
      <div style="font-size:13px;color:var(--muted)" id="pageSubtitle">Sentence Builder — load level via <code>?level=N</code></div>
    </div>

    <div class="controls">
      <button id="homeBtn" class="btn-ghost">Home</button>
      <button id="resetBtn" class="btn-ghost">Reset</button>
      <button id="soundToggle" class="btn-ghost">Sound: On</button>
    </div>
  </div>

  <div id="overall-bar"><div id="overall-fill"></div></div>

  <div class="panel" id="mainPanel">
    <!-- dynamic content -->
  </div>
</div>

<canvas id="confetti-canvas"></canvas>
<canvas id="fireworks-overlay"></canvas>

<!-- optional click sound - place rightclick.mp3 in same folder or remove audio usage -->
<audio id="clickSound" src="rightclick.mp3" preload="auto"></audio>

<script>

// toast helper — shows short positive/negative notifications
function showToast(text, kind='good', ms=900){
  try{
    let el = document.querySelector('.kg-toast')
    if(!el){
      el = document.createElement('div'); el.className = 'kg-toast'; document.body.appendChild(el)
    }
    el.textContent = text
    el.classList.remove('good','warn','show')
    el.classList.add(kind)
    // force reflow to restart animation
    void el.offsetWidth
    el.classList.add('show')
    clearTimeout(el._kg_to)
    el._kg_to = setTimeout(()=> el.classList.remove('show'), ms)
  }catch(e){ /* silently */ }
}



/* ========================================================================
   QUIZ DATA: Edit ONLY inside QUIZ_DATA. Each level contains `subLevels`,
   each subLevel is an array of 10 question objects:
     { scrambled: [...tokens...], answer: "Correct sentence.", type: "positive|yesno|wh|imperative" }
   ======================================================================== */
const QUIZ_DATA = {
  1: {
  level: 1,
  sentenceLength: 3,
  subLevels: [
    [
      { scrambled:["i","eat","rice"], answer:"I eat rice.", type:"positive" },
      { scrambled:["she","likes","tea"], answer:"She likes tea.", type:"positive" },
      { scrambled:["they","play","football"], answer:"They play football.", type:"positive" },
      { scrambled:["we","are","ready"], answer:"We are ready.", type:"positive" },
      { scrambled:["he","is","sleeping"], answer:"He is sleeping.", type:"positive" },
      { scrambled:["are","you","fine"], answer:"Are you fine?", type:"yesno" },
      { scrambled:["is","he","coming"], answer:"Is he coming?", type:"yesno" },
      { scrambled:["are","they","here"], answer:"Are they here?", type:"yesno" },
      { scrambled:["what","is","this"], answer:"What is this?", type:"wh" },
      { scrambled:["where","are","you"], answer:"Where are you?", type:"wh" }
    ],
    [
      { scrambled:["i","wash","clothes"], answer:"I wash clothes.", type:"positive" },
      { scrambled:["she","writes","stories"], answer:"She writes stories.", type:"positive" },
      { scrambled:["they","watch","tv"], answer:"They watch TV.", type:"positive" },
      { scrambled:["we","cook","food"], answer:"We cook food.", type:"positive" },
      { scrambled:["he","drinks","water"], answer:"He drinks water.", type:"positive" },
      { scrambled:["can","you","help"], answer:"Can you help?", type:"yesno" },
      { scrambled:["do","they","work"], answer:"Do they work?", type:"yesno" },
      { scrambled:["is","she","busy"], answer:"Is she busy?", type:"yesno" },
      { scrambled:["where","is","mom"], answer:"Where is mom?", type:"wh" },
      { scrambled:["why","are","you"], answer:"Why are you?", type:"wh" }
    ],
    [
      { scrambled:["eat","your","food"], answer:"Eat your food.", type:"imperative" },
      { scrambled:["wash","your","hands"], answer:"Wash your hands.", type:"imperative" },
      { scrambled:["open","the","door"], answer:"Open the door.", type:"imperative" },
      { scrambled:["close","the","window"], answer:"Close the window.", type:"imperative" },
      { scrambled:["take","the","bag"], answer:"Take the bag.", type:"imperative" },
      { scrambled:["what","is","that"], answer:"What is that?", type:"wh" },
      { scrambled:["who","is","there"], answer:"Who is there?", type:"wh" },
      { scrambled:["are","we","late"], answer:"Are we late?", type:"yesno" },
      { scrambled:["is","it","ready"], answer:"Is it ready?", type:"yesno" },
      { scrambled:["sit","down","please"], answer:"Sit down please.", type:"imperative" }
    ],
    [
      { scrambled:["i","love","music"], answer:"I love music.", type:"positive" },
      { scrambled:["she","eats","bread"], answer:"She eats bread.", type:"positive" },
      { scrambled:["they","play","games"], answer:"They play games.", type:"positive" },
      { scrambled:["we","need","help"], answer:"We need help.", type:"positive" },
      { scrambled:["he","likes","sports"], answer:"He likes sports.", type:"positive" },
      { scrambled:["can","she","come"], answer:"Can she come?", type:"yesno" },
      { scrambled:["do","you","agree"], answer:"Do you agree?", type:"yesno" },
      { scrambled:["what","is","inside"], answer:"What is inside?", type:"wh" },
      { scrambled:["where","am","i"], answer:"Where am I?", type:"wh" },
      { scrambled:["come","here","now"], answer:"Come here now.", type:"imperative" }
    ],
    [
      { scrambled:["she","is","kind"], answer:"She is kind.", type:"positive" },
      { scrambled:["he","likes","coffee"], answer:"He likes coffee.", type:"positive" },
      { scrambled:["i","am","ready"], answer:"I am ready.", type:"positive" },
      { scrambled:["we","are","home"], answer:"We are home.", type:"positive" },
      { scrambled:["they","are","happy"], answer:"They are happy.", type:"positive" },
      { scrambled:["are","you","sure"], answer:"Are you sure?", type:"yesno" },
      { scrambled:["is","this","yours"], answer:"Is this yours?", type:"yesno" },
      { scrambled:["what","is","wrong"], answer:"What is wrong?", type:"wh" },
      { scrambled:["where","is","dad"], answer:"Where is dad?", type:"wh" },
      { scrambled:["open","your","bag"], answer:"Open your bag.", type:"imperative" }
    ]
  ]
},

  2: { // Level 2: 4-word sentences (from your earlier set)
    level: 2,
    sentenceLength: 4,
    subLevels: [
      [
        { scrambled:["i","am","eating","rice"], answer:"I am eating rice.", type:"positive" },
        { scrambled:["she","is","reading","books"], answer:"She is reading books.", type:"positive" },
        { scrambled:["they","are","playing","games"], answer:"They are playing games.", type:"positive" },
        { scrambled:["we","are","learning","today"], answer:"We are learning today.", type:"positive" },
        { scrambled:["he","is","watching","tv"], answer:"He is watching TV.", type:"positive" },
        { scrambled:["i","will","finish","homework"], answer:"I will finish homework.", type:"positive" },
        { scrambled:["she","bought","a","book"], answer:"She bought a book.", type:"positive" },
        { scrambled:["they","found","the","cat"], answer:"They found the cat.", type:"positive" },
        { scrambled:["we","made","a","cake"], answer:"We made a cake.", type:"positive" },
        { scrambled:["he","opened","the","box"], answer:"He opened the box.", type:"positive" }
      ],
      [
        { scrambled:["are","you","coming","today"], answer:"Are you coming today?", type:"yesno" },
        { scrambled:["do","they","like","pizza"], answer:"Do they like pizza?", type:"yesno" },
        { scrambled:["does","she","know","him"], answer:"Does she know him?", type:"yesno" },
        { scrambled:["is","it","raining","now"], answer:"Is it raining now?", type:"yesno" },
        { scrambled:["will","you","help","me"], answer:"Will you help me?", type:"yesno" },
        { scrambled:["have","you","seen","this"], answer:"Have you seen this?", type:"yesno" },
        { scrambled:["are","they","at","home"], answer:"Are they at home?", type:"yesno" },
        { scrambled:["do","we","start","now"], answer:"Do we start now?", type:"yesno" },
        { scrambled:["did","he","call","you"], answer:"Did he call you?", type:"yesno" },
        { scrambled:["can","you","open","door"], answer:"Can you open the door?", type:"yesno" }
      ],
      [
        { scrambled:["where","are","you","going"], answer:"Where are you going?", type:"wh" },
        { scrambled:["what","did","she","buy"], answer:"What did she buy?", type:"wh" },
        { scrambled:["who","is","at","door"], answer:"Who is at the door?", type:"wh" },
        { scrambled:["when","will","we","meet"], answer:"When will we meet?", type:"wh" },
        { scrambled:["why","is","he","late"], answer:"Why is he late?", type:"wh" },
        { scrambled:["which","one","do","you"], answer:"Which one do you?", type:"wh" },
        { scrambled:["how","did","they","come"], answer:"How did they come?", type:"wh" },
        { scrambled:["whose","book","is","this"], answer:"Whose book is this?", type:"wh" },
        { scrambled:["what","are","you","doing"], answer:"What are you doing?", type:"wh" },
        { scrambled:["where","did","you","go"], answer:"Where did you go?", type:"wh" }
      ],
      [
        { scrambled:["please","open","the","door"], answer:"Please open the door.", type:"imperative" },
        { scrambled:["wash","your","hands","now"], answer:"Wash your hands now.", type:"imperative" },
        { scrambled:["bring","me","that","book"], answer:"Bring me that book.", type:"imperative" },
        { scrambled:["sit","down","and","listen"], answer:"Sit down and listen.", type:"imperative" },
        { scrambled:["turn","off","the","light"], answer:"Turn off the light.", type:"imperative" },
        { scrambled:["finish","your","meal","quickly"], answer:"Finish your meal quickly.", type:"imperative" },
        { scrambled:["write","the","answer","now"], answer:"Write the answer now.", type:"imperative" },
        { scrambled:["close","the","window","please"], answer:"Close the window please.", type:"imperative" },
        { scrambled:["bring","the","bags","here"], answer:"Bring the bags here.", type:"imperative" },
        { scrambled:["stand","up","and","speak"], answer:"Stand up and speak.", type:"imperative" }
      ],
      [
        { scrambled:["she","is","very","kind"], answer:"She is very kind.", type:"positive" },
        { scrambled:["do","you","want","tea"], answer:"Do you want tea?", type:"yesno" },
        { scrambled:["where","is","my","pen"], answer:"Where is my pen?", type:"wh" },
        { scrambled:["please","pass","the","salt"], answer:"Please pass the salt.", type:"imperative" },
        { scrambled:["they","bought","a","car"], answer:"They bought a car.", type:"positive" },
        { scrambled:["will","he","come","soon"], answer:"Will he come soon?", type:"yesno" },
        { scrambled:["what","did","you","say"], answer:"What did you say?", type:"wh" },
        { scrambled:["pick","up","the","keys"], answer:"Pick up the keys.", type:"imperative" },
        { scrambled:["we","found","new","home"], answer:"We found a new home.", type:"positive" },
        { scrambled:["can","you","play","piano"], answer:"Can you play the piano?", type:"yesno" }
      ]
    ]
  },

  3: { // Level 3: 5-word sentences (from your earlier set)
    level: 3,
    sentenceLength: 5,
    subLevels: [
      [
        { scrambled:["i","am","reading","a","book"], answer:"I am reading a book.", type:"positive" },
        { scrambled:["she","is","making","a","cake"], answer:"She is making a cake.", type:"positive" },
        { scrambled:["they","are","playing","football","today"], answer:"They are playing football today.", type:"positive" },
        { scrambled:["we","will","meet","at","noon"], answer:"We will meet at noon.", type:"positive" },
        { scrambled:["he","is","fixing","the","car"], answer:"He is fixing the car.", type:"positive" },
        { scrambled:["i","can","see","the","bird"], answer:"I can see the bird.", type:"positive" },
        { scrambled:["she","brought","her","new","bag"], answer:"She brought her new bag.", type:"positive" },
        { scrambled:["they","found","a","lost","cat"], answer:"They found a lost cat.", type:"positive" },
        { scrambled:["we","drank","coffee","after","class"], answer:"We drank coffee after class.", type:"positive" },
        { scrambled:["he","wants","to","learn","music"], answer:"He wants to learn music.", type:"positive" }
      ],
      [
        { scrambled:["are","you","going","to","school"], answer:"Are you going to school?", type:"yesno" },
        { scrambled:["do","they","want","to","join"], answer:"Do they want to join?", type:"yesno" },
        { scrambled:["will","she","come","to","party"], answer:"Will she come to the party?", type:"yesno" },
        { scrambled:["have","you","seen","my","keys"], answer:"Have you seen my keys?", type:"yesno" },
        { scrambled:["did","he","bring","the","book"], answer:"Did he bring the book?", type:"yesno" },
        { scrambled:["can","you","help","me","please"], answer:"Can you help me please?", type:"yesno" },
        { scrambled:["are","they","ready","for","test"], answer:"Are they ready for the test?", type:"yesno" },
        { scrambled:["could","you","open","the","door"], answer:"Could you open the door?", type:"yesno" },
        { scrambled:["does","she","like","that","song"], answer:"Does she like that song?", type:"yesno" },
        { scrambled:["should","we","start","right","now"], answer:"Should we start right now?", type:"yesno" }
      ],
      [
        { scrambled:["where","did","you","leave","it"], answer:"Where did you leave it?", type:"wh" },
        { scrambled:["what","are","they","doing","now"], answer:"What are they doing now?", type:"wh" },
        { scrambled:["who","will","attend","the","meeting"], answer:"Who will attend the meeting?", type:"wh" },
        { scrambled:["when","are","we","going","home"], answer:"When are we going home?", type:"wh" },
        { scrambled:["why","did","she","leave","early"], answer:"Why did she leave early?", type:"wh" },
        { scrambled:["which","book","do","you","prefer"], answer:"Which book do you prefer?", type:"wh" },
        { scrambled:["how","did","they","solve","that"], answer:"How did they solve that?", type:"wh" },
        { scrambled:["whose","phone","is","on","table"], answer:"Whose phone is on the table?", type:"wh" },
        { scrambled:["what","time","does","class","start"], answer:"What time does class start?", type:"wh" },
        { scrambled:["where","have","you","been","today"], answer:"Where have you been today?", type:"wh" }
      ],
      [
        { scrambled:["please","bring","me","a","glass"], answer:"Please bring me a glass.", type:"imperative" },
        { scrambled:["wash","your","hands","before","eating"], answer:"Wash your hands before eating.", type:"imperative" },
        { scrambled:["sit","quietly","and","read","book"], answer:"Sit quietly and read the book.", type:"imperative" },
        { scrambled:["turn","off","the","lights","please"], answer:"Turn off the lights please.", type:"imperative" },
        { scrambled:["make","sure","you","finish","work"], answer:"Make sure you finish the work.", type:"imperative" },
        { scrambled:["write","your","name","on","paper"], answer:"Write your name on paper.", type:"imperative" },
        { scrambled:["bring","the","box","to","me"], answer:"Bring the box to me.", type:"imperative" },
        { scrambled:["close","the","door","very","silently"], answer:"Close the door very silently.", type:"imperative" },
        { scrambled:["help","your","friend","with","homework"], answer:"Help your friend with homework.", type:"imperative" },
        { scrambled:["stand","in","line","and","wait"], answer:"Stand in line and wait.", type:"imperative" }
      ],
      [
        { scrambled:["i","think","he","is","right"], answer:"I think he is right.", type:"positive" },
        { scrambled:["do","you","remember","this","place"], answer:"Do you remember this place?", type:"yesno" },
        { scrambled:["where","did","they","hide","it"], answer:"Where did they hide it?", type:"wh" },
        { scrambled:["please","tell","me","the","truth"], answer:"Please tell me the truth.", type:"imperative" },
        { scrambled:["they","are","going","to","school"], answer:"They are going to school.", type:"positive" },
        { scrambled:["will","you","be","there","today"], answer:"Will you be there today?", type:"yesno" },
        { scrambled:["what","did","she","just","say"], answer:"What did she just say?", type:"wh" },
        { scrambled:["bring","those","files","to","me"], answer:"Bring those files to me.", type:"imperative" },
        { scrambled:["we","should","start","the","project"], answer:"We should start the project.", type:"positive" },
        { scrambled:["can","you","solve","this","problem"], answer:"Can you solve this problem?", type:"yesno" }
      ]
    ]
  },

  4: {
  level: 4,
  sentenceLength: 6,
  subLevels: [
    [
      { scrambled:["i","have","lost","my","key","today"], answer:"I have lost my key today.", type:"positive" },
      { scrambled:["she","is","making","dinner","right","now"], answer:"She is making dinner right now.", type:"positive" },
      { scrambled:["they","are","waiting","for","the","bus"], answer:"They are waiting for the bus.", type:"positive" },
      { scrambled:["we","will","visit","your","house","tomorrow"], answer:"We will visit your house tomorrow.", type:"positive" },
      { scrambled:["he","cleaned","the","kitchen","very","well"], answer:"He cleaned the kitchen very well.", type:"positive" },
      { scrambled:["are","you","coming","to","the","party"], answer:"Are you coming to the party?", type:"yesno" },
      { scrambled:["can","she","finish","this","work","now"], answer:"Can she finish this work now?", type:"yesno" },
      { scrambled:["where","did","you","keep","the","bag"], answer:"Where did you keep the bag?", type:"wh" },
      { scrambled:["why","is","he","angry","with","you"], answer:"Why is he angry with you?", type:"wh" },
      { scrambled:["please","bring","me","a","glass","now"], answer:"Please bring me a glass now.", type:"imperative" }
    ],
    [
      { scrambled:["i","am","looking","for","my","wallet"], answer:"I am looking for my wallet.", type:"positive" },
      { scrambled:["she","visited","her","grandparents","last","week"], answer:"She visited her grandparents last week.", type:"positive" },
      { scrambled:["they","will","start","the","meeting","soon"], answer:"They will start the meeting soon.", type:"positive" },
      { scrambled:["we","have","cleaned","the","whole","room"], answer:"We have cleaned the whole room.", type:"positive" },
      { scrambled:["he","wrote","a","letter","to","me"], answer:"He wrote a letter to me.", type:"positive" },
      { scrambled:["do","you","want","some","more","rice"], answer:"Do you want some more rice?", type:"yesno" },
      { scrambled:["did","she","see","my","message","yet"], answer:"Did she see my message yet?", type:"yesno" },
      { scrambled:["where","can","i","find","your","house"], answer:"Where can I find your house?", type:"wh" },
      { scrambled:["what","time","does","school","finish","today"], answer:"What time does school finish today?", type:"wh" },
      { scrambled:["please","put","the","books","on","table"], answer:"Please put the books on the table.", type:"imperative" }
    ],
    [
      { scrambled:["i","forgot","to","bring","my","lunch"], answer:"I forgot to bring my lunch.", type:"positive" },
      { scrambled:["she","needs","to","buy","some","fruits"], answer:"She needs to buy some fruits.", type:"positive" },
      { scrambled:["they","are","studying","for","the","test"], answer:"They are studying for the test.", type:"positive" },
      { scrambled:["we","packed","our","bags","last","night"], answer:"We packed our bags last night.", type:"positive" },
      { scrambled:["he","left","his","phone","at","work"], answer:"He left his phone at work.", type:"positive" },
      { scrambled:["can","you","show","me","the","note"], answer:"Can you show me the note?", type:"yesno" },
      { scrambled:["are","they","ready","for","the","exam"], answer:"Are they ready for the exam?", type:"yesno" },
      { scrambled:["why","did","you","close","the","window"], answer:"Why did you close the window?", type:"wh" },
      { scrambled:["how","can","we","solve","this","problem"], answer:"How can we solve this problem?", type:"wh" },
      { scrambled:["please","bring","your","files","to","me"], answer:"Please bring your files to me.", type:"imperative" }
    ],
    [
      { scrambled:["i","will","clean","the","room","now"], answer:"I will clean the room now.", type:"positive" },
      { scrambled:["she","has","washed","all","the","clothes"], answer:"She has washed all the clothes.", type:"positive" },
      { scrambled:["they","need","to","fix","this","issue"], answer:"They need to fix this issue.", type:"positive" },
      { scrambled:["we","are","planning","a","small","trip"], answer:"We are planning a small trip.", type:"positive" },
      { scrambled:["he","is","writing","a","long","story"], answer:"He is writing a long story.", type:"positive" },
      { scrambled:["do","you","know","where","he","lives"], answer:"Do you know where he lives?", type:"yesno" },
      { scrambled:["are","we","going","to","eat","now"], answer:"Are we going to eat now?", type:"yesno" },
      { scrambled:["where","did","she","leave","her","bag"], answer:"Where did she leave her bag?", type:"wh" },
      { scrambled:["what","is","your","plan","for","today"], answer:"What is your plan for today?", type:"wh" },
      { scrambled:["please","write","your","name","here","now"], answer:"Please write your name here now.", type:"imperative" }
    ],
    [
      { scrambled:["i","have","found","my","lost","earring"], answer:"I have found my lost earring.", type:"positive" },
      { scrambled:["she","sent","the","email","this","morning"], answer:"She sent the email this morning.", type:"positive" },
      { scrambled:["they","bought","a","new","car","yesterday"], answer:"They bought a new car yesterday.", type:"positive" },
      { scrambled:["we","will","cook","dinner","at","home"], answer:"We will cook dinner at home.", type:"positive" },
      { scrambled:["he","is","waiting","outside","your","house"], answer:"He is waiting outside your house.", type:"positive" },
      { scrambled:["can","you","bring","me","some","water"], answer:"Can you bring me some water?", type:"yesno" },
      { scrambled:["is","she","coming","to","class","today"], answer:"Is she coming to class today?", type:"yesno" },
      { scrambled:["why","did","they","leave","so","early"], answer:"Why did they leave so early?", type:"wh" },
      { scrambled:["where","can","we","buy","fresh","bread"], answer:"Where can we buy fresh bread?", type:"wh" },
      { scrambled:["please","hand","me","that","red","book"], answer:"Please hand me that red book.", type:"imperative" }
    ]
  ]
},

  5: { // Level 5: 7-word sentences (sample)
    level: 5,
    sentenceLength: 7,
    subLevels: [
      [
        { scrambled:["i","have","to","finish","my","homework","today"], answer:"I have to finish my homework today.", type:"positive" },
        { scrambled:["could","you","please","close","the","window","now"], answer:"Could you please close the window now?", type:"yesno" },
        { scrambled:["where","did","you","leave","your","school","bag"], answer:"Where did you leave your school bag?", type:"wh" },
        { scrambled:["please","make","sure","to","lock","the","door"], answer:"Please make sure to lock the door.", type:"imperative" },
        { scrambled:["they","will","arrive","at","the","station","soon"], answer:"They will arrive at the station soon.", type:"positive" },
        { scrambled:["what","would","you","do","in","that","case"], answer:"What would you do in that case?", type:"wh" },
        { scrambled:["do","you","want","me","to","help","you"], answer:"Do you want me to help you?", type:"yesno" },
        { scrambled:["she","did","not","tell","me","the","truth"], answer:"She did not tell me the truth.", type:"positive" },
        { scrambled:["bring","everything","you","need","for","the","trip"], answer:"Bring everything you need for the trip.", type:"imperative" },
        { scrambled:["how","can","we","make","this","work","better"], answer:"How can we make this work better?", type:"wh" }
      ],
      // additional sublevels: keep simple variations for demonstration
      [
        { scrambled:["we","have","been","working","on","this","project"], answer:"We have been working on this project.", type:"positive" },
        { scrambled:["will","they","be","available","next","week","end"], answer:"Will they be available next weekend?", type:"yesno" },
        { scrambled:["why","did","you","not","answer","my","call"], answer:"Why did you not answer my call?", type:"wh" },
        { scrambled:["please","take","your","shoes","off","at","door"], answer:"Please take your shoes off at the door.", type:"imperative" },
        { scrambled:["i","wonder","if","she","will","come","today"], answer:"I wonder if she will come today.", type:"positive" },
        { scrambled:["what","time","should","we","meet","on","monday"], answer:"What time should we meet on Monday?", type:"wh" },
        { scrambled:["do","you","remember","the","name","of","place"], answer:"Do you remember the name of the place?", type:"yesno" },
        { scrambled:["they","did","not","finish","their","homework","yet"], answer:"They did not finish their homework yet.", type:"positive" },
        { scrambled:["please","tell","me","exactly","what","happened","there"], answer:"Please tell me exactly what happened there.", type:"imperative" },
        { scrambled:["how","long","will","the","journey","take","today"], answer:"How long will the journey take today?", type:"wh" }
      ],
      [
        { scrambled:["i","don't","think","this","is","a","good"], answer:"I don't think this is a good idea.", type:"positive" },
        { scrambled:["can","you","explain","that","to","me","again"], answer:"Can you explain that to me again?", type:"yesno" },
        { scrambled:["which","one","of","these","should","we","choose"], answer:"Which one of these should we choose?", type:"wh" },
        { scrambled:["please","remind","me","to","call","her","later"], answer:"Please remind me to call her later.", type:"imperative" },
        { scrambled:["they","have","been","to","this","place","before"], answer:"They have been to this place before.", type:"positive" },
        { scrambled:["what","did","you","think","of","the","film"], answer:"What did you think of the film?", type:"wh" },
        { scrambled:["do","we","need","any","special","equipment","today"], answer:"Do we need any special equipment today?", type:"yesno" },
        { scrambled:["she","wants","to","become","a","doctor","later"], answer:"She wants to become a doctor later.", type:"positive" },
        { scrambled:["please","place","your","answer","in","the","box"], answer:"Please place your answer in the box.", type:"imperative" },
        { scrambled:["how","should","we","approach","this","problem","now"], answer:"How should we approach this problem now?", type:"wh" }
      ],
      [
        { scrambled:["we","shouldn't","forget","to","bring","maps","tomorrow"], answer:"We shouldn't forget to bring maps tomorrow.", type:"positive" },
        { scrambled:["could","you","please","show","me","the","way"], answer:"Could you please show me the way?", type:"yesno" },
        { scrambled:["who","else","is","coming","to","the","party"], answer:"Who else is coming to the party?", type:"wh" },
        { scrambled:["please","listen","carefully","to","the","instructions","now"], answer:"Please listen carefully to the instructions now.", type:"imperative" },
        { scrambled:["they","have","planned","to","meet","later","today"], answer:"They have planned to meet later today.", type:"positive" },
        { scrambled:["what","is","the","best","time","to","call"], answer:"What is the best time to call?", type:"wh" },
        { scrambled:["do","you","think","this","will","work","out"], answer:"Do you think this will work out?", type:"yesno" },
        { scrambled:["she","forgot","to","send","the","important","mail"], answer:"She forgot to send the important mail.", type:"positive" },
        { scrambled:["please","check","the","door","is","locked","now"], answer:"Please check the door is locked now.", type:"imperative" },
        { scrambled:["how","many","people","will","attend","the","meeting"], answer:"How many people will attend the meeting?", type:"wh" }
      ]
    ]
  },

  6: { // Level 6: 8-word sentences
    level: 6,
    sentenceLength: 8,
    subLevels: [
      // one sublevel shown; remaining follow similar pattern
      [
        { scrambled:["i","have","been","waiting","for","you","since","morning"], answer:"I have been waiting for you since morning.", type:"positive" },
        { scrambled:["can","you","tell","me","where","it","was","left"], answer:"Can you tell me where it was left?", type:"yesno" },
        { scrambled:["what","are","the","main","points","of","the","plan"], answer:"What are the main points of the plan?", type:"wh" },
        { scrambled:["please","make","sure","all","lights","are","turned","off"], answer:"Please make sure all lights are turned off.", type:"imperative" },
        { scrambled:["they","should","have","completed","this","task","by","now"], answer:"They should have completed this task by now.", type:"positive" },
        { scrambled:["how","did","you","manage","to","finish","everything","so"], answer:"How did you manage to finish everything so quickly?", type:"wh" },
        { scrambled:["do","you","think","we","can","trust","them","now"], answer:"Do you think we can trust them now?", type:"yesno" },
        { scrambled:["please","hand","over","the","documents","to","the","manager"], answer:"Please hand over the documents to the manager.", type:"imperative" },
        { scrambled:["we","will","be","starting","the","project","next","week"], answer:"We will be starting the project next week.", type:"positive" },
        { scrambled:["what","would","you","prefer","for","dinner","tonight"], answer:"What would you prefer for dinner tonight?", type:"wh" }
      ],
      // for brevity remaining sublevels would be similar; you can edit later
      [],[],[]
    ]
  },

  7: {
  level: 7,
  sentenceLength: 9,
  subLevels: [

    /* -----------------------------  
       SUB-LEVEL 1 — POSITIVE  
       ----------------------------- */
    [
      { scrambled:["she","is","making","dinner","for","her","family","at","home"], answer:"She is making dinner for her family at home.", type:"positive" },
      { scrambled:["they","are","studying","together","for","the","big","exam","tomorrow"], answer:"They are studying together for the big exam tomorrow.", type:"positive" },
      { scrambled:["he","is","cleaning","the","kitchen","floor","right","after","breakfast"], answer:"He is cleaning the kitchen floor right after breakfast.", type:"positive" },
      { scrambled:["we","are","planning","to","visit","our","grandparents","this","weekend"], answer:"We are planning to visit our grandparents this weekend.", type:"positive" },
      { scrambled:["i","am","working","on","my","new","project","at","school"], answer:"I am working on my new project at school.", type:"positive" },
      { scrambled:["she","is","learning","how","to","paint","beautiful","flowers","today"], answer:"She is learning how to paint beautiful flowers today.", type:"positive" },
      { scrambled:["they","are","buying","groceries","for","the","party","this","evening"], answer:"They are buying groceries for the party this evening.", type:"positive" },
      { scrambled:["we","are","walking","to","the","park","after","finishing","lunch"], answer:"We are walking to the park after finishing lunch.", type:"positive" },
      { scrambled:["i","am","reading","a","story","book","in","my","room"], answer:"I am reading a story book in my room.", type:"positive" },
      { scrambled:["he","is","taking","care","of","his","younger","brother","today"], answer:"He is taking care of his younger brother today.", type:"positive" }
    ],

    /* -----------------------------  
       SUB-LEVEL 2 — YES/NO  
       ----------------------------- */
    [
      { scrambled:["are","you","going","to","finish","the","assignment","today","sir"], answer:"Are you going to finish the assignment today sir?", type:"yesno" },
      { scrambled:["do","they","need","any","help","with","the","new","task"], answer:"Do they need any help with the new task?", type:"yesno" },
      { scrambled:["can","we","speak","with","the","manager","later","this","afternoon"], answer:"Can we speak with the manager later this afternoon?", type:"yesno" },
      { scrambled:["is","she","coming","to","school","with","you","this","morning"], answer:"Is she coming to school with you this morning?", type:"yesno" },
      { scrambled:["did","he","finish","cleaning","the","room","before","leaving","yesterday"], answer:"Did he finish cleaning the room before leaving yesterday?", type:"yesno" },
      { scrambled:["are","they","waiting","for","us","outside","the","main","gate"], answer:"Are they waiting for us outside the main gate?", type:"yesno" },
      { scrambled:["will","you","join","the","meeting","later","this","evening","sir"], answer:"Will you join the meeting later this evening sir?", type:"yesno" },
      { scrambled:["have","you","read","the","instructions","before","starting","the","test"], answer:"Have you read the instructions before starting the test?", type:"yesno" },
      { scrambled:["can","she","carry","the","heavy","bag","by","herself","now"], answer:"Can she carry the heavy bag by herself now?", type:"yesno" },
      { scrambled:["did","we","forget","to","bring","the","keys","with","us"], answer:"Did we forget to bring the keys with us?", type:"yesno" }
    ],

    /* -----------------------------  
       SUB-LEVEL 3 — WH QUESTIONS  
       ----------------------------- */
    [
      { scrambled:["where","are","you","planning","to","go","after","the","class"], answer:"Where are you planning to go after the class?", type:"wh" },
      { scrambled:["what","time","does","the","movie","start","this","evening","sir"], answer:"What time does the movie start this evening sir?", type:"wh" },
      { scrambled:["who","is","bringing","the","snacks","for","our","group","meeting"], answer:"Who is bringing the snacks for our group meeting?", type:"wh" },
      { scrambled:["when","will","they","complete","the","work","on","this","project"], answer:"When will they complete the work on this project?", type:"wh" },
      { scrambled:["why","is","she","crying","in","the","classroom","right","now"], answer:"Why is she crying in the classroom right now?", type:"wh" },
      { scrambled:["which","bag","did","you","buy","from","the","new","shop"], answer:"Which bag did you buy from the new shop?", type:"wh" },
      { scrambled:["how","can","we","improve","our","skills","for","the","competition"], answer:"How can we improve our skills for the competition?", type:"wh" },
      { scrambled:["whose","jacket","did","you","find","on","the","school","bench"], answer:"Whose jacket did you find on the school bench?", type:"wh" },
      { scrambled:["what","are","they","doing","in","the","library","right","now"], answer:"What are they doing in the library right now?", type:"wh" },
      { scrambled:["where","did","he","put","the","keys","after","opening","door"], answer:"Where did he put the keys after opening the door?", type:"wh" }
    ],

    /* -----------------------------  
       SUB-LEVEL 4 — IMPERATIVE  
       ----------------------------- */
    [
      { scrambled:["please","bring","your","notebook","to","the","table","right","now"], answer:"Please bring your notebook to the table right now.", type:"imperative" },
      { scrambled:["turn","off","the","lights","before","leaving","the","classroom","now"], answer:"Turn off the lights before leaving the classroom now.", type:"imperative" },
      { scrambled:["wash","your","hands","properly","before","you","eat","your","meal"], answer:"Wash your hands properly before you eat your meal.", type:"imperative" },
      { scrambled:["help","your","friend","finish","the","homework","before","the","bell"], answer:"Help your friend finish the homework before the bell.", type:"imperative" },
      { scrambled:["write","your","name","clearly","on","the","paper","before","submitting"], answer:"Write your name clearly on the paper before submitting.", type:"imperative" },
      { scrambled:["listen","carefully","to","the","instructions","during","the","entire","lesson"], answer:"Listen carefully to the instructions during the entire lesson.", type:"imperative" },
      { scrambled:["close","all","the","windows","before","you","leave","the","room"], answer:"Close all the windows before you leave the room.", type:"imperative" },
      { scrambled:["bring","the","blue","box","to","me","from","the","shelf"], answer:"Bring the blue box to me from the shelf.", type:"imperative" },
      { scrambled:["clean","your","desk","properly","after","you","finish","your","project"], answer:"Clean your desk properly after you finish your project.", type:"imperative" },
      { scrambled:["place","the","books","neatly","on","the","table","right","now"], answer:"Place the books neatly on the table right now.", type:"imperative" }
    ],

    /* -----------------------------  
       SUB-LEVEL 5 — MIXED FINAL  
       ----------------------------- */
    [
      { scrambled:["why","is","she","running","so","fast","in","the","hallway"], answer:"Why is she running so fast in the hallway?", type:"wh" },
      { scrambled:["please","give","me","the","paper","from","your","bag","now"], answer:"Please give me the paper from your bag now.", type:"imperative" },
      { scrambled:["he","is","looking","for","his","lost","wallet","right","now"], answer:"He is looking for his lost wallet right now.", type:"positive" },
      { scrambled:["are","you","joining","us","for","the","trip","next","week"], answer:"Are you joining us for the trip next week?", type:"yesno" },
      { scrambled:["what","are","you","doing","with","the","tools","right","now"], answer:"What are you doing with the tools right now?", type:"wh" },
      { scrambled:["bring","your","sports","shoes","to","school","tomorrow","for","practice"], answer:"Bring your sports shoes to school tomorrow for practice.", type:"imperative" },
      { scrambled:["they","are","waiting","for","the","bus","near","the","library"], answer:"They are waiting for the bus near the library.", type:"positive" },
      { scrambled:["will","he","help","us","with","the","project","this","evening"], answer:"Will he help us with the project this evening?", type:"yesno" },
      { scrambled:["where","did","you","put","the","blue","bottle","yesterday","sir"], answer:"Where did you put the blue bottle yesterday sir?", type:"wh" },
      { scrambled:["she","is","preparing","a","special","meal","for","everyone","today"], answer:"She is preparing a special meal for everyone today.", type:"positive" }
    ]

  ]
},


8: {
  level: 8,
  sentenceLength: 10,
  subLevels: [

    /* -----------------------------
       SUB-LEVEL 1 — POSITIVE
       ----------------------------- */
    [
      { scrambled:["she","is","preparing","a","healthy","meal","for","her","family","now"], answer:"She is preparing a healthy meal for her family now.", type:"positive" },
      { scrambled:["they","are","walking","to","the","park","after","finishing","their","lunch"], answer:"They are walking to the park after finishing their lunch.", type:"positive" },
      { scrambled:["he","is","cleaning","the","kitchen","because","it","was","very","messy"], answer:"He is cleaning the kitchen because it was very messy.", type:"positive" },
      { scrambled:["we","are","packing","our","bags","for","the","trip","next","week"], answer:"We are packing our bags for the trip next week.", type:"positive" },
      { scrambled:["i","am","working","on","my","drawing","project","after","school","today"], answer:"I am working on my drawing project after school today.", type:"positive" },
      { scrambled:["she","is","watering","the","plants","in","the","garden","every","morning"], answer:"She is watering the plants in the garden every morning.", type:"positive" },
      { scrambled:["they","are","playing","a","fun","game","outside","with","their","friends"], answer:"They are playing a fun game outside with their friends.", type:"positive" },
      { scrambled:["we","are","cleaning","our","classroom","before","the","teacher","arrives","today"], answer:"We are cleaning our classroom before the teacher arrives today.", type:"positive" },
      { scrambled:["i","am","learning","how","to","cook","simple","meals","at","home"], answer:"I am learning how to cook simple meals at home.", type:"positive" },
      { scrambled:["he","is","organising","his","study","table","to","keep","it","clean"], answer:"He is organising his study table to keep it clean.", type:"positive" }
    ],

    /* -----------------------------
       SUB-LEVEL 2 — YES/NO
       ----------------------------- */
    [
      { scrambled:["are","you","joining","us","for","the","school","event","this","evening"], answer:"Are you joining us for the school event this evening?", type:"yesno" },
      { scrambled:["do","they","need","any","extra","chairs","for","the","group","meeting"], answer:"Do they need any extra chairs for the group meeting?", type:"yesno" },
      { scrambled:["can","we","finish","the","project","before","the","deadline","this","week"], answer:"Can we finish the project before the deadline this week?", type:"yesno" },
      { scrambled:["is","she","coming","with","us","to","the","market","right","now"], answer:"Is she coming with us to the market right now?", type:"yesno" },
      { scrambled:["did","he","lock","the","main","door","before","he","left","home"], answer:"Did he lock the main door before he left home?", type:"yesno" },
      { scrambled:["are","they","bringing","their","books","for","the","class","today","sir"], answer:"Are they bringing their books for the class today sir?", type:"yesno" },
      { scrambled:["will","you","help","me","complete","this","task","after","school","today"], answer:"Will you help me complete this task after school today?", type:"yesno" },
      { scrambled:["have","you","checked","your","bag","before","leaving","the","house","today"], answer:"Have you checked your bag before leaving the house today?", type:"yesno" },
      { scrambled:["can","she","carry","all","these","heavy","bags","by","herself","now"], answer:"Can she carry all these heavy bags by herself now?", type:"yesno" },
      { scrambled:["did","we","forget","to","bring","the","keys","when","leaving","home"], answer:"Did we forget to bring the keys when leaving home?", type:"yesno" }
    ],

    /* -----------------------------
       SUB-LEVEL 3 — WH QUESTIONS
       ----------------------------- */
    [
      { scrambled:["where","are","you","going","with","the","bag","in","your","hand"], answer:"Where are you going with the bag in your hand?", type:"wh" },
      { scrambled:["what","time","does","the","school","bus","arrive","at","your","stop"], answer:"What time does the school bus arrive at your stop?", type:"wh" },
      { scrambled:["who","is","bringing","the","cake","for","the","birthday","party","today"], answer:"Who is bringing the cake for the birthday party today?", type:"wh" },
      { scrambled:["when","will","they","finish","painting","the","wall","in","the","hall"], answer:"When will they finish painting the wall in the hall?", type:"wh" },
      { scrambled:["why","is","she","crying","after","talking","to","the","teacher","today"], answer:"Why is she crying after talking to the teacher today?", type:"wh" },
      { scrambled:["which","shirt","did","you","buy","from","the","shop","last","night"], answer:"Which shirt did you buy from the shop last night?", type:"wh" },
      { scrambled:["how","can","we","solve","this","problem","in","a","better","way"], answer:"How can we solve this problem in a better way?", type:"wh" },
      { scrambled:["whose","bag","did","you","find","near","the","table","this","morning"], answer:"Whose bag did you find near the table this morning?", type:"wh" },
      { scrambled:["what","are","they","doing","outside","during","the","break","right","now"], answer:"What are they doing outside during the break right now?", type:"wh" },
      { scrambled:["where","did","he","put","the","keys","after","opening","the","gate"], answer:"Where did he put the keys after opening the gate?", type:"wh" }
    ],

    /* -----------------------------
       SUB-LEVEL 4 — IMPERATIVE
       ----------------------------- */
    [
      { scrambled:["please","bring","your","blue","file","to","my","desk","right","now"], answer:"Please bring your blue file to my desk right now.", type:"imperative" },
      { scrambled:["clean","your","room","properly","before","you","go","to","sleep","tonight"], answer:"Clean your room properly before you go to sleep tonight.", type:"imperative" },
      { scrambled:["wash","your","hands","carefully","before","you","start","eating","your","meal"], answer:"Wash your hands carefully before you start eating your meal.", type:"imperative" },
      { scrambled:["help","your","friend","complete","the","work","before","the","bell","rings"], answer:"Help your friend complete the work before the bell rings.", type:"imperative" },
      { scrambled:["write","your","full","name","clearly","on","the","paper","before","submitting"], answer:"Write your full name clearly on the paper before submitting.", type:"imperative" },
      { scrambled:["listen","carefully","to","the","teacher","during","the","entire","class","period"], answer:"Listen carefully to the teacher during the entire class period.", type:"imperative" },
      { scrambled:["close","all","the","windows","before","you","leave","the","room","today"], answer:"Close all the windows before you leave the room today.", type:"imperative" },
      { scrambled:["bring","the","brown","box","to","me","from","the","top","shelf"], answer:"Bring the brown box to me from the top shelf.", type:"imperative" },
      { scrambled:["clean","your","desk","properly","after","you","finish","your","group","project"], answer:"Clean your desk properly after you finish your group project.", type:"imperative" },
      { scrambled:["place","the","books","neatly","on","the","table","before","you","leave"], answer:"Place the books neatly on the table before you leave.", type:"imperative" }
    ],

    /* -----------------------------
       SUB-LEVEL 5 — MIXED FINAL
       ----------------------------- */
    [
      { scrambled:["why","is","he","running","so","fast","in","the","school","hallway"], answer:"Why is he running so fast in the school hallway?", type:"wh" },
      { scrambled:["please","give","me","the","red","book","from","your","bag","now"], answer:"Please give me the red book from your bag now.", type:"imperative" },
      { scrambled:["they","are","waiting","for","the","bus","near","the","park","today"], answer:"They are waiting for the bus near the park today.", type:"positive" },
      { scrambled:["are","you","bringing","your","lunch","with","you","to","school","today"], answer:"Are you bringing your lunch with you to school today?", type:"yesno" },
      { scrambled:["what","are","you","doing","with","the","papers","on","the","table"], answer:"What are you doing with the papers on the table?", type:"wh" },
      { scrambled:["bring","your","sports","shoes","to","school","tomorrow","for","team","practice"], answer:"Bring your sports shoes to school tomorrow for team practice.", type:"imperative" },
      { scrambled:["she","is","preparing","a","special","meal","for","everyone","at","home"], answer:"She is preparing a special meal for everyone at home.", type:"positive" },
      { scrambled:["will","he","join","us","for","the","group","project","later","today"], answer:"Will he join us for the group project later today?", type:"yesno" },
      { scrambled:["where","did","you","put","the","blue","bottle","yesterday","evening","sir"], answer:"Where did you put the blue bottle yesterday evening sir?", type:"wh" },
      { scrambled:["he","is","cleaning","his","room","because","it","was","very","dirty"], answer:"He is cleaning his room because it was very dirty.", type:"positive" }
    ]

  ]
},

9: {
  level: 9,
  sentenceLength: 11,
  subLevels: [

    /* -------------------------
       SUB-LEVEL 1 (Daily Positive)
       ------------------------- */
    [
      { scrambled:["i","will","meet","you","at","the","park","after","school","today","later"], answer:"I will meet you at the park after school today later.", type:"positive" },
      { scrambled:["she","has","been","waiting","for","the","bus","since","early","this","morning"], answer:"She has been waiting for the bus since early this morning.", type:"positive" },
      { scrambled:["they","are","planning","to","visit","their","grandparents","during","the","long","holiday"], answer:"They are planning to visit their grandparents during the long holiday.", type:"positive" },
      { scrambled:["we","want","to","finish","our","project","before","the","deadline","next","week"], answer:"We want to finish our project before the deadline next week.", type:"positive" },
      { scrambled:["he","is","trying","to","learn","how","to","play","the","piano","properly"], answer:"He is trying to learn how to play the piano properly.", type:"positive" },
      { scrambled:["they","have","decided","to","move","to","a","new","house","next","month"], answer:"They have decided to move to a new house next month.", type:"positive" },
      { scrambled:["i","am","hoping","to","see","you","again","at","the","event","tomorrow"], answer:"I am hoping to see you again at the event tomorrow.", type:"positive" },
      { scrambled:["we","are","going","to","cook","dinner","for","the","whole","family","tonight"], answer:"We are going to cook dinner for the whole family tonight.", type:"positive" },
      { scrambled:["she","wants","to","buy","a","gift","for","her","friend","this","evening"], answer:"She wants to buy a gift for her friend this evening.", type:"positive" },
      { scrambled:["they","will","start","their","journey","early","in","the","morning","tomorrow","before"], answer:"They will start their journey early in the morning tomorrow before.", type:"positive" }
    ],

    /* -------------------------
       SUB-LEVEL 2 (Yes/No Questions)
       ------------------------- */
    [
      { scrambled:["do","you","want","to","have","dinner","with","us","at","the","restaurant"], answer:"Do you want to have dinner with us at the restaurant?", type:"yesno" },
      { scrambled:["are","they","going","to","join","the","meeting","later","in","the","afternoon"], answer:"Are they going to join the meeting later in the afternoon?", type:"yesno" },
      { scrambled:["will","she","be","able","to","come","to","the","party","next","saturday"], answer:"Will she be able to come to the party next Saturday?", type:"yesno" },
      { scrambled:["can","you","help","me","carry","these","bags","to","the","car","outside"], answer:"Can you help me carry these bags to the car outside?", type:"yesno" },
      { scrambled:["did","he","remember","to","bring","the","documents","for","the","meeting","today"], answer:"Did he remember to bring the documents for the meeting today?", type:"yesno" },
      { scrambled:["have","you","seen","my","wallet","anywhere","in","the","living","room","recently"], answer:"Have you seen my wallet anywhere in the living room recently?", type:"yesno" },
      { scrambled:["are","we","going","to","travel","together","during","the","next","school","holiday"], answer:"Are we going to travel together during the next school holiday?", type:"yesno" },
      { scrambled:["can","they","finish","the","assignment","before","the","deadline","this","friday","morning"], answer:"Can they finish the assignment before the deadline this Friday morning?", type:"yesno" },
      { scrambled:["should","i","bring","anything","special","for","the","event","at","school","today"], answer:"Should I bring anything special for the event at school today?", type:"yesno" },
      { scrambled:["will","you","be","free","to","meet","us","after","class","this","evening"], answer:"Will you be free to meet us after class this evening?", type:"yesno" }
    ],

    /* -------------------------
       SUB-LEVEL 3 (Wh-Questions)
       ------------------------- */
    [
      { scrambled:["where","did","you","put","the","keys","that","i","gave","you","yesterday"], answer:"Where did you put the keys that I gave you yesterday?", type:"wh" },
      { scrambled:["why","are","they","planning","to","move","to","a","different","city","soon"], answer:"Why are they planning to move to a different city soon?", type:"wh" },
      { scrambled:["what","time","will","the","train","arrive","at","the","station","tomorrow","morning"], answer:"What time will the train arrive at the station tomorrow morning?", type:"wh" },
      { scrambled:["when","are","we","going","to","start","the","meeting","for","this","project"], answer:"When are we going to start the meeting for this project?", type:"wh" },
      { scrambled:["who","is","responsible","for","cleaning","the","classroom","after","the","event","today"], answer:"Who is responsible for cleaning the classroom after the event today?", type:"wh" },
      { scrambled:["how","did","she","manage","to","finish","the","task","so","quickly","yesterday"], answer:"How did she manage to finish the task so quickly yesterday?", type:"wh" },
      { scrambled:["which","team","is","going","to","win","the","match","later","this","evening"], answer:"Which team is going to win the match later this evening?", type:"wh" },
      { scrambled:["what","item","did","you","want","me","to","buy","from","the","market"], answer:"What item did you want me to buy from the market?", type:"wh" },
      { scrambled:["where","can","i","find","a","quiet","place","to","study","right","now"], answer:"Where can I find a quiet place to study right now?", type:"wh" },
      { scrambled:["why","did","they","cancel","the","trip","at","the","last","minute","yesterday"], answer:"Why did they cancel the trip at the last minute yesterday?", type:"wh" }
    ],

    /* -------------------------
       SUB-LEVEL 4 (Imperatives)
       ------------------------- */
    [
      { scrambled:["please","bring","all","your","books","to","the","classroom","before","we","start"], answer:"Please bring all your books to the classroom before we start.", type:"imperative" },
      { scrambled:["write","your","name","clearly","on","the","paper","before","you","submit","it"], answer:"Write your name clearly on the paper before you submit it.", type:"imperative" },
      { scrambled:["help","me","carry","these","heavy","boxes","to","the","car","outside","now"], answer:"Help me carry these heavy boxes to the car outside now.", type:"imperative" },
      { scrambled:["turn","off","all","the","lights","before","you","leave","the","room","tonight"], answer:"Turn off all the lights before you leave the room tonight.", type:"imperative" },
      { scrambled:["please","send","me","the","updated","file","when","you","finish","working","today"], answer:"Please send me the updated file when you finish working today.", type:"imperative" },
      { scrambled:["bring","your","completed","homework","to","the","teacher","before","the","class","starts"], answer:"Bring your completed homework to the teacher before the class starts.", type:"imperative" },
      { scrambled:["make","sure","to","lock","the","door","when","you","leave","the","building"], answer:"Make sure to lock the door when you leave the building.", type:"imperative" },
      { scrambled:["please","clean","the","table","after","you","finish","eating","your","breakfast"], answer:"Please clean the table after you finish eating your breakfast.", type:"imperative" },
      { scrambled:["take","these","documents","to","the","office","as","soon","as","possible","today"], answer:"Take these documents to the office as soon as possible today.", type:"imperative" },
      { scrambled:["check","the","answers","carefully","before","you","submit","your","test","paper","now"], answer:"Check the answers carefully before you submit your test paper now.", type:"imperative" }
    ],

    /* -------------------------
       SUB-LEVEL 5 (Mixed)
       ------------------------- */
    [
      { scrambled:["i","hope","to","finish","this","assignment","before","the","deadline","next","week"], answer:"I hope to finish this assignment before the deadline next week.", type:"positive" },
      { scrambled:["do","you","want","to","join","us","for","lunch","at","school","today"], answer:"Do you want to join us for lunch at school today?", type:"yesno" },
      { scrambled:["where","did","you","learn","to","cook","such","delicious","food","like","that"], answer:"Where did you learn to cook such delicious food like that?", type:"wh" },
      { scrambled:["please","help","me","to","move","this","table","to","the","corner","now"], answer:"Please help me to move this table to the corner now.", type:"imperative" },
      { scrambled:["they","are","hoping","to","find","a","new","apartment","in","this","area"], answer:"They are hoping to find a new apartment in this area.", type:"positive" },
      { scrambled:["will","you","be","able","to","finish","the","task","by","tomorrow","morning"], answer:"Will you be able to finish the task by tomorrow morning?", type:"yesno" },
      { scrambled:["what","time","are","we","supposed","to","reach","the","station","this","evening"], answer:"What time are we supposed to reach the station this evening?", type:"wh" },
      { scrambled:["bring","your","sports","uniform","for","the","game","later","this","afternoon"], answer:"Bring your sports uniform for the game later this afternoon.", type:"imperative" },
      { scrambled:["she","wants","to","improve","her","english","before","the","exam","next","month"], answer:"She wants to improve her English before the exam next month.", type:"positive" },
      { scrambled:["how","can","you","finish","the","project","without","asking","for","any","help"], answer:"How can you finish the project without asking for any help?", type:"wh" }
    ]
  ]
},


  10:{ level:10, sentenceLength:12, subLevels: [ [], [], [], [], [] ] }
};

/* =========================
   Engine JS - paste only
   ========================= */

/* helpers */
function qs(sel){ return document.querySelector(sel) }
function qsa(sel){ return Array.from(document.querySelectorAll(sel)) }
function shuffle(arr){ return arr ? arr.slice().sort(()=>Math.random()-0.5) : [] }
function clamped(n,min,max){ return Math.max(min,Math.min(max,n)) }

/* engine state & elements */
let engine = null

/* Audio context for tones */
const AudioCtx = window.AudioContext || window.webkitAudioContext
let audioCtx = null
try{ audioCtx = new AudioCtx() }catch(e){ audioCtx = null }
const clickAudio = qs('#clickSound') || (function(){
  // fallback silent audio element to avoid null checks
  const a = document.createElement('audio'); a.id = 'clickSound'; a.preload='auto'; return a
})()

/* confetti / fireworks setup */
const confCanvas = qs('#confetti-canvas'), cctx = confCanvas ? confCanvas.getContext('2d') : null
const fwCanvas = qs('#fireworks-overlay'), fwCtx = fwCanvas ? fwCanvas.getContext('2d') : null
function resizeCanvas(){ if(confCanvas){ confCanvas.width = innerWidth; confCanvas.height = innerHeight } if(fwCanvas){ fwCanvas.width = innerWidth; fwCanvas.height = innerHeight } }
window.addEventListener('resize', resizeCanvas); resizeCanvas()
let confetti = [], confRunning=false, fireworks=[], fwRunning=false

function launchConfetti(count=60){
  if(!cctx) return
  confetti = []
  const colors = ['#ffda32','#ff6b6b','#00eaff','#00c2a8','#ffd45e','#7b61ff']
  for(let i=0;i<count;i++){
    confetti.push({
      x: Math.random()*confCanvas.width,
      y: -Math.random()*confCanvas.height,
      vx: (Math.random()-0.5)*4,
      vy: 2 + Math.random()*6,
      r: 4 + Math.random()*8,
      col: colors[Math.floor(Math.random()*colors.length)],
      rot: Math.random()*360
    })
  }
  if(!confRunning){ confRunning=true; requestAnimationFrame(stepConfetti) }
}
function stepConfetti(){
  if(!cctx) return
  cctx.clearRect(0,0,confCanvas.width,confCanvas.height)
  confetti.forEach(p=>{
    p.x += p.vx; p.y += p.vy; p.rot += p.vx;
    cctx.save(); cctx.translate(p.x,p.y); cctx.rotate(p.rot*Math.PI/180);
    cctx.fillStyle = p.col; cctx.fillRect(-p.r/2,-p.r/2,p.r,p.r*0.6); cctx.restore()
  })
  confetti = confetti.filter(p=>p.y < confCanvas.height + 50)
  if(confetti.length) requestAnimationFrame(stepConfetti); else confRunning=false
}

function spawnFireworksBurst(x=(fwCanvas ? fwCanvas.width : 800)/2, y=(fwCanvas ? fwCanvas.height : 400)/3, count=30){
  if(!fwCtx) return
  for(let i=0;i<count;i++){
    const angle = (Math.PI*2/count)*i
    fireworks.push({
      x,y,
      vx: Math.cos(angle)*(2+Math.random()*4),
      vy: Math.sin(angle)*(2+Math.random()*4),
      life: 80 + Math.floor(Math.random()*60),
      r: 2 + Math.random()*3,
      color: `hsl(${Math.floor(Math.random()*360)},80%,60%)`
    })
  }
  if(!fwRunning){ fwRunning=true; fwCanvas.style.display='block'; requestAnimationFrame(stepFireworks) }
}
function stepFireworks(){
  if(!fwCtx) return
  fwCtx.clearRect(0,0,fwCanvas.width,fwCanvas.height)
  fireworks.forEach(p=>{
    p.x += p.vx; p.y += p.vy; p.vy += 0.03; p.life--;
    fwCtx.beginPath(); fwCtx.fillStyle = p.color; fwCtx.globalAlpha = Math.max(0,p.life/120);
    fwCtx.arc(p.x,p.y,p.r,0,Math.PI*2); fwCtx.fill()
  })
  fireworks = fireworks.filter(p=>p.life>0)
  if(fireworks.length) requestAnimationFrame(stepFireworks); else { fwRunning=false; if(fwCanvas) fwCanvas.style.display='none' }
}

/* Tone functions */
function playTone(freq, type='sine', len=0.12, gain=0.12){
  if(!audioCtx || !engine || !engine.soundOn) return
  const o = audioCtx.createOscillator(), g = audioCtx.createGain()
  o.type = type; o.frequency.value = freq
  g.gain.setValueAtTime(gain, audioCtx.currentTime)
  o.connect(g); g.connect(audioCtx.destination)
  o.start(); setTimeout(()=>{ try{o.stop()}catch(e){} }, len*1000)
}
function playCorrect(){ if(audioCtx && audioCtx.state==='suspended') audioCtx.resume(); playTone(880,'sine',0.09,0.08); setTimeout(()=>playTone(1100,'sine',0.09,0.06),90); setTimeout(()=>playTone(1320,'sine',0.09,0.05),180) }
function playWrong(){ if(audioCtx && audioCtx.state==='suspended') audioCtx.resume(); playTone(160,'sawtooth',0.26,0.12) }
function playComplete(){ if(audioCtx && audioCtx.state==='suspended') audioCtx.resume(); playTone(660,'triangle',0.09,0.12); setTimeout(()=>playTone(880,'triangle',0.09,0.12),120); setTimeout(()=>playTone(1320,'triangle',0.14,0.12),240) }

/* Utility normalize - remove punctuation, lowercase, compress spaces */
function normalise(s){
  if(!s) return ''
  return s.toLowerCase().replace(/[“”‘’"']/g,'').replace(/[^\w\s\?\.]/g,'').replace(/\s+/g,' ').trim()
}

/* Save/load progress to localStorage */
const STORAGE_KEY = 'keynote-grammar-progress'
function saveProgress(obj){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)) }catch(e){} }
function loadProgress(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}') }catch(e){ return {} } }

/* ---------- Toast helper (JS) - requires CSS in your <style>:
   .kg-toast { position: fixed; left:50%; transform:translateX(-50%) translateY(20px); top:10vh; ... }
   .kg-toast.show { opacity:1; transform:translateX(-50%) translateY(0); } etc.
*/
function showToast(text, kind='good', ms=900){
  try{
    let el = document.querySelector('.kg-toast')
    if(!el){
      el = document.createElement('div'); el.className = 'kg-toast'; document.body.appendChild(el)
    }
    el.textContent = text
    el.classList.remove('good','warn','show')
    el.classList.add(kind)
    void el.offsetWidth
    el.classList.add('show')
    clearTimeout(el._kg_to)
    el._kg_to = setTimeout(()=> el.classList.remove('show'), ms)
  }catch(e){}
}

/* QuizEngine class */
class QuizEngine {
  constructor(levelNumber){
    this.levelNumber = Number(levelNumber) || 1
    if(!QUIZ_DATA[this.levelNumber]) this.levelNumber = 1
    this.data = QUIZ_DATA[this.levelNumber]
    this.totalSubs = (this.data.subLevels || []).length || 0

    // dynamic state
    this.currentSub = 0
    this.questions = []
    this.qIndex = 0
    this.score = 0
    this.xp = 0
    this.bankHistory = [] // stores {tile}
    this.soundOn = true
    this._autoSubmitting = false

    this.progress = loadProgress() || {}
    this._restoreProgressIfAny()

    this._renderShell()
    this._bindGlobalButtons()
    this.renderIntroOrStart()
  }

  _restoreProgressIfAny(){
    const p = this.progress[`level${this.levelNumber}`]
    if(p && typeof p.currentSub === 'number') this.currentSub = clamped(p.currentSub,0,this.totalSubs-1)
  }

  _renderShell(){
    const title = qs('#pageTitle'), subtitle = qs('#pageSubtitle')
    if(title) title.textContent = `Keynote Grammar — Level ${this.levelNumber}`
    if(subtitle) subtitle.textContent = `Sentence Builder — ${this.data.sentenceLength || '?'}-word sentences • Need 8/10 to pass`
    this.mainPanel = qs('#mainPanel')
    this.overallFill = qs('#overall-fill')
    this.updateOverallBar()
  }

  _bindGlobalButtons(){
    const home = qs('#homeBtn'), reset = qs('#resetBtn'), stBtn = qs('#soundToggle')
    if(home) home.addEventListener('click', ()=> this.showLevelSelect())
    if(reset) reset.addEventListener('click', ()=> {
      if(!confirm('Reset saved progress for this level?')) return
      this.progress[`level${this.levelNumber}`] = { currentSub: 0 }
      saveProgress(this.progress)
      this.currentSub = 0
      this.updateOverallBar()
      this.renderIntroOrStart()
      alert('Progress reset for this level.')
    })
    if(stBtn) stBtn.addEventListener('click', ()=> { this.soundOn = !this.soundOn; stBtn.textContent = 'Sound: ' + (this.soundOn ? 'On' : 'Off') })
  }

  updateOverallBar(){
    const pct = this.totalSubs ? (this.currentSub / this.totalSubs) * 100 : 0
    if(this.overallFill) this.overallFill.style.width = pct + '%'
  }

  renderIntroOrStart(){
    const params = new URLSearchParams(location.search)
    const hasLevelParam = params.has('level')
    if(!hasLevelParam){
      this.showLevelSelect()
      return
    }
    this.renderIntro()
  }

  showLevelSelect(){
    const saved = loadProgress()
    this.mainPanel.innerHTML = `<h2>Select level</h2>
      <div class="level-grid" id="levelGrid"></div>
      <p style="margin-top:12px;color:var(--muted)">Or open this page with <code>?level=N</code>.</p>`
    const grid = qs('#levelGrid')
    for(let i=1;i<=10;i++){
      const card = document.createElement('div')
      card.className = 'level-card'
      card.innerHTML = `<div style="font-weight:700">Level ${i}</div><div style="font-size:13px;color:var(--muted);margin-top:6px">${(QUIZ_DATA[i] && QUIZ_DATA[i].sentenceLength) ? QUIZ_DATA[i].sentenceLength+'-word' : ''}</div>`
      card.addEventListener('click', ()=> { location.search = '?level=' + i })
      grid.appendChild(card)
    }
  }

  renderIntro(){
    this.mainPanel.innerHTML = `
      <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap">
        <div style="min-width:220px">
          <div style="font-weight:600">Level ${this.levelNumber} — Sub-level <span id="intro-sub-num">${this.currentSub+1}</span></div>
          <div style="color:var(--muted);font-size:13px;margin-top:6px">Each sub-level contains 10 scrambled sentences. Need 8/10 to pass.</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="startBtn" class="btn-primary">Start Sub-level</button>
        </div>
      </div>`
    qs('#startBtn').addEventListener('click', ()=> this.startSubLevel())
  }

  startSubLevel(){
    const subs = this.data.subLevels || []
    if(!subs[this.currentSub] || !subs[this.currentSub].length){
      this.mainPanel.innerHTML = `<div style="text-align:center;padding:30px"><div style="font-size:18px;font-weight:700">No data for sub-level ${this.currentSub+1}</div><div style="color:var(--muted);margin-top:8px">Edit QUIZ_DATA to provide questions for this sub-level.</div></div>`
      return
    }
    this.questions = shuffle(subs[this.currentSub]).slice(0,10)
    this.qIndex = 0
    this.score = 0
    this.xp = 0
    this.bankHistory = []
    this._renderGameShell()
    this.renderQuestion()
  }

  /* --------- _renderGameShell (no submit button) --------- */
  _renderGameShell(){
    this.mainPanel.innerHTML = `
      <div class="top-row">
        <div>
          <div id="progressTxt" class="progress-text">Question 1 of 10</div>
          <div style="font-size:13px;color:var(--muted)">Sub-level: <strong id="currentSub">${this.currentSub+1}</strong></div>
        </div>

        <div class="xp-wrap">
          <div style="font-size:13px;color:var(--muted)">XP</div>
          <div id="xp-bar"><div id="xp-fill"></div></div>
        </div>

        <div class="stars" title="Stars">
          <span class="star" id="star1">★</span>
          <span class="star" id="star2">★</span>
          <span class="star" id="star3">★</span>
        </div>
      </div>

      <div class="bank-answer">
        <div class="word-bank" id="wordBank">
          <div class="zone-title">Word Bank <span id="punctHint" class="punct-badge" style="display:none">?</span></div>
          <div id="bankArea"></div>
        </div>

        <div class="answer-zone" id="answerZone">
          <div class="zone-title">Your Answer (click tiles to move)</div>
          <div id="answerArea"></div>
        </div>
      </div>

      <div class="actions">
        <button id="undoBtn" class="btn-ghost">Undo</button>
      </div>

      <div id="message"></div>
    `

    this.bankArea = qs('#bankArea')
    this.answerArea = qs('#answerArea')
    this.progressTxt = qs('#progressTxt')
    this.xpFill = qs('#xp-fill')
    this.starEls = [qs('#star1'), qs('#star2'), qs('#star3')]
    this.punctHint = qs('#punctHint')
    this.messageEl = qs('#message')

    qs('#undoBtn').addEventListener('click', ()=> this.undo())

    document.addEventListener('click', ()=>{ if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume() }, { once:true })
  }

  /* --------- renderQuestion (auto-submit on punctuation) --------- */
  renderQuestion(){
    this.messageEl.textContent = ''
    const q = this.questions[this.qIndex]
    if(!q) return

    if(q.type === 'yesno' || q.type === 'wh'){ 
      this.punctHint.style.display = 'inline-block'
      this.punctHint.textContent='?' 
    } else { 
      this.punctHint.style.display='none' 
    }

    this.bankArea.innerHTML = ''
    this.answerArea.innerHTML = ''
    this.bankHistory = []

    const correct = q.answer.trim()
    const correctTokens = correct.replace(/[?!\.]+$/,'').split(/\s+/)

    const findDisplay = (token) => {
      const norm = token.replace(/[^\w]/g,'').toLowerCase()
      for(let w of correctTokens){
        if(w.replace(/[^\w]/g,'').toLowerCase() === norm) return w
      }
      if(norm==='tv') return 'TV'
      if(norm==='i') return 'I'
      return token
    }

    let tiles = (q.scrambled || []).slice()
    const punct = (q.type === 'yesno' || q.type === 'wh') ? '?' : '.'
    tiles.push(punct)
    tiles = shuffle(tiles)

    tiles.forEach((tok) => {
      const tile = document.createElement('div')
      tile.className = 'word-tile'
      tile.tabIndex = 0

      if(tok === '?' || tok === '.'){
        tile.classList.add('punct')
        tile.textContent = tok
        tile.dataset.word = tok
      } else {
        const display = findDisplay(tok)
        const firstNorm = correctTokens[0] ? correctTokens[0].replace(/[^\w]/g,'').toLowerCase() : ''
        if(tok.replace(/[^\w]/g,'').toLowerCase() === firstNorm){
          tile.textContent = display.charAt(0).toUpperCase() + display.slice(1)
        } else {
          tile.textContent = display
        }
        tile.dataset.word = tok
      }

      tile.addEventListener('click', () => {
        if(this.soundOn && clickAudio){
          try{ clickAudio.currentTime = 0; clickAudio.play().catch(()=>{}) }catch(e){}
        }

        this.answerArea.appendChild(tile)
        tile.classList.add('answer-tile')
        this.bankHistory.push({ tile })

        // AUTO SUBMIT WHEN PUNCTUATION IS CLICKED
        const isPunct = tile.dataset.word === '?' || tile.dataset.word === '.'
        if(isPunct){
          if(this._autoSubmitting) return
          this._autoSubmitting = true
          setTimeout(()=> {
            this.submitAnswer()
            setTimeout(()=> this._autoSubmitting = false, 800)
          }, 120)
        }
      })

      this.bankArea.appendChild(tile)
    })

    this.progressTxt.textContent = `Question ${this.qIndex+1} of 10`
    qs('#currentSub') && (qs('#currentSub').textContent = this.currentSub+1)
    this.updateStars(this.score)
    this.updateXP()
  }

  undo(){
    if(!this.bankHistory.length) return
    const last = this.bankHistory.pop()
    if(!last || !last.tile) return
    const tile = last.tile
    tile.classList.remove('answer-tile')
    this.bankArea.appendChild(tile)
  }

  submitAnswer(){
    const selectedTiles = Array.from(this.answerArea.querySelectorAll('.word-tile'))

    let user = ''
    selectedTiles.forEach(t => {
      const txt = (t.textContent || '').trim()
      if(txt === '?' || txt === '.'){
        user = user.trim() + txt
      } else {
        user += (user.length ? ' ' : '') + txt
      }
    })

    user = user.replace(/\s+/g,' ').trim()

    const q = this.questions[this.qIndex]
    if(!q) return
    const correct = q.answer.trim()

    if(normalise(user) === normalise(correct)){
      this.score++
      this.xp = clamped(this.xp + 10, 0, 100)
      this.messageEl.textContent = 'Correct! — ' + correct
      this.messageEl.style.color = 'var(--success)'
      playCorrect()

      const praises = ['Good!', 'Well done!', 'Correct!', 'Nice!', 'Excellent!']
      const p = praises[Math.floor(Math.random()*praises.length)]
      showToast(p,'good',900)

    } else {
      this.messageEl.textContent = 'Wrong — correct: ' + correct
      this.messageEl.style.color = 'var(--danger)'
      playWrong()
      this.answerArea.classList.remove('shake'); void this.answerArea.offsetWidth; this.answerArea.classList.add('shake')
      showToast('Wrong','warn',800)
      this.updateStars(this.score)
      this.updateXP()
      return
    }

    this.updateStars(this.score)
    this.updateXP()

    this.qIndex++
    setTimeout(()=> {
      if(this.qIndex < 10) this.renderQuestion()
      else this.finishSubLevel()
    }, 520)
  }

  finishSubLevel(){
    const passed = this.score >= 8

    this.progress[`level${this.levelNumber}`] = this.progress[`level${this.levelNumber}`] || {}
    this.progress[`level${this.levelNumber}`].currentSub = this.currentSub
    if(passed){
      this.progress[`level${this.levelNumber}`].completed =
        Math.max(this.progress[`level${this.levelNumber}`].completed || 0, this.currentSub+1)
    }
    saveProgress(this.progress)

    this.mainPanel.innerHTML = `
      <div style="text-align:center">
        <div style="font-weight:700;font-size:18px">Sub-level complete</div>
        <div style="margin-top:8px;color:var(--muted)">Score: <strong id="finalScore">${this.score}</strong>/10</div>
        <div id="passMsg" style="margin-top:8px;color:var(--muted)">${passed ? 'Passed — well done!' : 'Failed — you need at least 8 correct.'}</div>
        <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
          <button id="nextBtn" class="btn-primary">${passed ? 'Next Sub-level' : 'Retry'}</button>
          <button id="homeBtnLocal" class="btn-ghost">Level Select</button>
        </div>
      </div>
    `

    qs('#homeBtnLocal').addEventListener('click', ()=> this.showLevelSelect())
    qs('#nextBtn').addEventListener('click', ()=> {
      if(!passed){
        this.startSubLevel()
        return
      }
      this.currentSub++
      this.updateOverallBar()
      if(this.currentSub >= this.totalSubs){
        this.finishLevel()
      } else {
        this.renderIntro()
      }
      playComplete()
      launchConfetti(60)
      spawnFireworksBurst()
    })
  }

  finishLevel(){
    this.progress[`level${this.levelNumber}`] = this.progress[`level${this.levelNumber}`] || {}
    this.progress[`level${this.levelNumber}`].completed = this.totalSubs
    saveProgress(this.progress)

    this.mainPanel.innerHTML = `<div style="text-align:center;padding:30px">
      <div style="font-size:20px;font-weight:700">LEVEL ${this.levelNumber} COMPLETE</div>
      <div style="color:var(--muted);margin-top:8px">You passed all sub-levels</div>
      <div style="margin-top:12px"><button id="returnHome" class="btn-ghost">Return Home</button></div>
    </div>`
    qs('#returnHome').addEventListener('click', ()=> this.showLevelSelect())
    playComplete(); launchConfetti(100); spawnFireworksBurst()
  }

  updateXP(){ if(this.xpFill) this.xpFill.style.width = this.xp + '%' }
  updateStars(score){ const count = score >= 9 ? 3 : score >= 8 ? 2 : score >= 6 ? 1 : 0; this.starEls.forEach((el,i)=> el.classList.toggle('active', i < count)) }
  scoreToStars(s){ if(s>=9) return 3; if(s>=8) return 2; if(s>=6) return 1; return 0 }
}

/* Initialize engine based on ?level or show select */
function init(){
  const params = new URLSearchParams(location.search)
  const level = params.get('level') || null
  if(level){
    engine = new QuizEngine(level)
  } else {
    engine = new QuizEngine(1)
    engine.showLevelSelect()
  }
}

window.addEventListener('DOMContentLoaded', init)

/* ===============================
   THEME TOGGLE
   =============================== */
const modeBtn = document.createElement("button");
modeBtn.textContent = "Mode: Dark";
modeBtn.className = "btn-ghost";
const controlsEl = document.querySelector(".controls")
if(controlsEl) controlsEl.appendChild(modeBtn);

function applyTheme(t){
  document.documentElement.setAttribute("data-theme", t);
  modeBtn.textContent = t === "dark" ? "Mode: Dark" : "Mode: Light";
  localStorage.setItem("keynote-theme", t);
}

let savedTheme = localStorage.getItem("keynote-theme") || "dark";
applyTheme(savedTheme);

modeBtn.addEventListener("click", () => {
  const t = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark";
  applyTheme(t);
});

/* ===============================
   TILE FLY ANIMATION
   =============================== */
document.addEventListener("click", e => {
  if(e.target.classList && e.target.classList.contains("word-tile")){
    e.target.classList.add("fly");
    setTimeout(()=> e.target.classList.remove("fly"), 450);
  }
});



</script>
</body>
</html>
